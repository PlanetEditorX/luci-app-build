name: é€šç”¨ LuCI åº”ç”¨è‡ªåŠ¨ç¼–è¯‘-å•åŒ…ï¼ˆOpenWRT 24.10.2ï¼‰

on:
  workflow_dispatch:  # âœ… æ‰‹åŠ¨è§¦å‘
  push:               # âœ… è‡ªåŠ¨è§¦å‘
    paths:
      - 'luci-app-*/**'  # âœ… ä»…å½“ luci-app-xxx ç›®å½•ä¸‹æ–‡ä»¶å˜åŠ¨æ—¶è§¦å‘

jobs:
  build-luci-app:
    runs-on: ubuntu-22.04
    steps:
      - name: 1. æ‹‰å–ä»“åº“ä»£ç ï¼ˆå«luci-app-xxxï¼‰
        uses: actions/checkout@v4

      - name: 2. å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update -y || true
          sudo apt install -y \
            build-essential git wget tar zstd xz-utils \
            python3 python3-dev python3-setuptools swig

      - name: 3. åŠ¨æ€è¯†åˆ«ä»“åº“ä¸­çš„luci-app-xxxåŒ…
        id: detect-package
        run: |
          ls -l
          # ä»ä»“åº“çš„ç›®å½•ä¸­æŸ¥æ‰¾luci-app-*åŒ…ï¼ˆæ”¯æŒå•ä¸ªåŒ…ï¼‰
          PKG_DIR=$(find "$GITHUB_WORKSPACE/" -mindepth 1 -maxdepth 1 -type d -name "luci-app-*" | head -n1)
          if [ -z "$PKG_DIR" ]; then
            echo "âŒ æœªåœ¨ä»“åº“ç›®å½•ä¸‹æ‰¾åˆ°luci-app-*åŒ…ï¼Œè¯·æ£€æŸ¥ä»“åº“ç»“æ„"; exit 1;
          fi
          PKG_NAME=$(basename "$PKG_DIR")  # æå–åŒ…åï¼ˆå¦‚luci-app-helloï¼‰
          echo "âœ… è¯†åˆ«åˆ°ç›®æ ‡åŒ…ï¼š$PKG_NAME"
          # è¾“å‡ºä¸ºç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "PKG_NAME=$PKG_NAME" >> "$GITHUB_ENV"

      - name: 4. ä¸‹è½½å¹¶è§£å‹ OpenWRT SDK
        run: |
          RUNNER_HOME="/home/runner"
          SDK_URL="https://downloads.openwrt.org/releases/24.10.2/targets/mediatek/filogic/openwrt-sdk-24.10.2-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          SDK_TAR="openwrt-sdk-24.10.2.tar.zst"
          SDK_DIR="$RUNNER_HOME/openwrt-sdk-filogic"
          SDK_FOLDER="openwrt-sdk-24.10.2-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64"

          # åˆ›å»ºSDKç›®å½•å¹¶ä¸‹è½½
          mkdir -p "$SDK_DIR" && cd "$SDK_DIR"
          echo "ğŸ” å½“å‰SDKç›®å½•ï¼š$SDK_DIR"
          if [ ! -f "$SDK_TAR" ]; then
            wget "$SDK_URL" -O "$SDK_TAR" || { echo "âŒ SDKä¸‹è½½å¤±è´¥"; exit 1; }
          fi

          # è§£å‹SDK
          if [ ! -d "$SDK_FOLDER" ]; then
            zstd -d "$SDK_TAR" && tar -xf "${SDK_TAR%.zst}" || { echo "âŒ SDKè§£å‹å¤±è´¥"; exit 1; }
          fi
          if [ ! -d "$SDK_DIR/$SDK_FOLDER" ]; then
            echo "âŒ SDKè§£å‹åè·¯å¾„ä¸å­˜åœ¨ï¼š$SDK_DIR/$SDK_FOLDER"; exit 1;
          fi
          echo "âœ… SDKè§£å‹å®Œæˆï¼Œè·¯å¾„ï¼š$SDK_DIR/$SDK_FOLDER"

      - name: 5. å¤åˆ¶ä»“åº“ä¸­çš„luci-app-xxxåˆ°SDKå¹¶åˆå§‹åŒ–Feeds
        run: |
          RUNNER_HOME="/home/runner"
          SDK_DIR="$RUNNER_HOME/openwrt-sdk-filogic"
          SDK_FOLDER="openwrt-sdk-24.10.2-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64"
          FULL_SDK_PATH="$SDK_DIR/$SDK_FOLDER"
          PKG_NAME="${{ env.PKG_NAME }}"  # ä»ç¯å¢ƒå˜é‡è·å–åŠ¨æ€åŒ…å

          # éªŒè¯SDKè·¯å¾„
          echo "ğŸ” å‡†å¤‡è¿›å…¥SDKè·¯å¾„ï¼š$FULL_SDK_PATH"
          if [ ! -d "$FULL_SDK_PATH" ]; then
            echo "âŒ SDKè·¯å¾„ä¸å­˜åœ¨ï¼å½“å‰ç›®å½•ä¸‹æ–‡ä»¶ï¼š"; ls -l "$SDK_DIR"; exit 1;
          fi
          cd "$FULL_SDK_PATH" || { echo "âŒ è¿›å…¥SDKç›®å½•å¤±è´¥"; exit 1; }

          # åˆå§‹åŒ–Feeds
          > feeds.conf.default
          echo 'src-git base https://github.com/openwrt/openwrt.git;openwrt-24.10' >> feeds.conf.default
          echo 'src-git packages https://github.com/openwrt/packages.git;master' >> feeds.conf.default
          echo 'src-git luci https://github.com/openwrt/luci.git;openwrt-24.10' >> feeds.conf.default
          ./scripts/feeds update -a || { echo "âŒ Feedsæ›´æ–°å¤±è´¥"; exit 1; }
          ./scripts/feeds install -a || { echo "âŒ Feedså®‰è£…å¤±è´¥"; exit 1; }

          # å°†ä»“åº“ä¸­çš„luci-app-xxxå¤åˆ¶åˆ°SDKçš„packageç›®å½•
          echo "ğŸ”„ å¤åˆ¶ä»“åº“ä¸­çš„$PKG_NAMEåˆ°SDK..."
          rm -rf "package/$PKG_NAME"  # æ¸…ç†æ—§åŒ…ï¼ˆè‹¥å­˜åœ¨ï¼‰
          cp -r "$GITHUB_WORKSPACE/$PKG_NAME" "package/" || { echo "âŒ å¤åˆ¶åŒ…æ–‡ä»¶å¤±è´¥"; exit 1; }
          echo "âœ… åŒ…æ–‡ä»¶å¤åˆ¶å®Œæˆï¼š$PKG_NAME"

      - name: 6. ç¼–è¯‘åŠ¨æ€è¯†åˆ«çš„luci-app-xxx
        run: |
          RUNNER_HOME="/home/runner"
          SDK_DIR="$RUNNER_HOME/openwrt-sdk-filogic"
          SDK_FOLDER="openwrt-sdk-24.10.2-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64"
          OUTPUT_DIR="$RUNNER_HOME/luci-build-ipk"
          FULL_SDK_PATH="$SDK_DIR/$SDK_FOLDER"
          PKG_NAME="${{ env.PKG_NAME }}"  # åŠ¨æ€åŒ…å

          # è¿›å…¥SDKç›®å½•
          cd "$FULL_SDK_PATH" || { echo "âŒ è¿›å…¥SDKç›®å½•å¤±è´¥"; exit 1; }

          # è¡¥å…¨é…ç½®ï¼ˆè‡ªåŠ¨é€‚é…å½“å‰åŒ…çš„ä¾èµ–ï¼‰
          if [ ! -f ".config" ]; then
            make defconfig
          fi
          echo "CONFIG_PACKAGE_$PKG_NAME=y" >> .config  # å¯ç”¨å½“å‰åŒ…
          make defconfig || { echo "âŒ é…ç½®ç”Ÿæˆå¤±è´¥"; exit 1; }

          # æ¸…ç†æ—§äº§ç‰© + ç¼–è¯‘
          make package/$PKG_NAME/clean V=s || { echo "âš ï¸  æ— æ—§äº§ç‰©å¯æ¸…ç†"; }
          make package/$PKG_NAME/compile V=s -j1 || { echo "âŒ ç¼–è¯‘å¤±è´¥"; exit 1; }

          # æŸ¥æ‰¾å¹¶å¤åˆ¶IPKï¼ˆåŠ¨æ€é€‚é…åŒ…åï¼‰
          mkdir -p "$OUTPUT_DIR"
          ARCH_DIR=$(find "bin/packages/" -maxdepth 1 -type d ! -name "*.ipk" ! -name "packages" | head -n1)
          IPK_PATH=$(find "$ARCH_DIR/" | grep "$PKG_NAME")
          if [ -z "$IPK_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ°$PKG_NAMEçš„IPKæ–‡ä»¶"; exit 1;
          fi
          cp -f "$IPK_PATH" "$OUTPUT_DIR/"
          echo "âœ… ç¼–è¯‘å®Œæˆï¼IPKè·¯å¾„ï¼š$OUTPUT_DIR/$(basename $IPK_PATH)"

      - name: 7. ä¸Šä¼ ç¼–è¯‘äº§ç‰©ï¼ˆå«åŠ¨æ€åŒ…åï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: "${{ env.PKG_NAME }}-ipk"  # äº§ç‰©ååŒ…å«åŠ¨æ€åŒ…å
          path: /home/runner/luci-build-ipk/${{ env.PKG_NAME }}_*.ipk
          retention-days: 30

      - name: 8. å‘å¸ƒåˆ° GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "auto-${{ github.run_id }}"
          name: "è‡ªåŠ¨å‘å¸ƒ ${{ github.run_id }}"
          files: /home/runner/luci-build-ipk/*.ipk
          body: |
            ğŸ‰ è‡ªåŠ¨ç¼–è¯‘å®Œæˆï¼
            åŒ…åˆ—è¡¨ï¼š${{ env.PKG_LIST }}
            æ—¶é—´ï¼š${{ github.event.head_commit.timestamp || github.run_started_at }}


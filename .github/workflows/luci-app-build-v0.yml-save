name: Luci App Helloï¼ˆOpenWRT 24.10.2ï¼‰

on:
  workflow_dispatch:
  # push:
  #   branches: [ main ]

jobs:
  build-luci-app:
    runs-on: ubuntu-22.04
    steps:
      - name: 1. æ‹‰å– luci-app-build ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: 2. å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update -y || true
          sudo apt install -y \
            build-essential git wget tar zstd xz-utils \
            python3 python3-dev python3-setuptools swig

      - name: 3. ä¸‹è½½å¹¶è§£å‹ OpenWRT SDKï¼ˆç¡¬ç¼–ç è·¯å¾„ï¼‰
        run: |
          # å…³é”®ï¼šç›´æ¥ä½¿ç”¨ GitHub Runner å›ºå®šå®¶ç›®å½• /home/runnerï¼Œä¸ä¾èµ–å˜é‡
          RUNNER_HOME="/home/runner"
          SDK_URL="https://downloads.openwrt.org/releases/24.10.2/targets/mediatek/filogic/openwrt-sdk-24.10.2-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          SDK_TAR="openwrt-sdk-24.10.2.tar.zst"
          SDK_DIR="$RUNNER_HOME/openwrt-sdk-filogic"
          SDK_FOLDER="openwrt-sdk-24.10.2-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64"

          # åˆ›å»ºç›®å½•å¹¶ä¸‹è½½SDK
          mkdir -p "$SDK_DIR" && cd "$SDK_DIR"
          echo "ğŸ” å½“å‰SDKç›®å½•ï¼š$SDK_DIR"
          if [ ! -f "$SDK_TAR" ]; then
            wget "$SDK_URL" -O "$SDK_TAR" || { echo "âŒ SDKä¸‹è½½å¤±è´¥"; exit 1; }
          fi

          # è§£å‹SDK
          if [ ! -d "$SDK_FOLDER" ]; then
            zstd -d "$SDK_TAR" && tar -xf "${SDK_TAR%.zst}" || { echo "âŒ SDKè§£å‹å¤±è´¥"; exit 1; }
          fi
          # éªŒè¯è§£å‹åçš„è·¯å¾„
          if [ ! -d "$SDK_DIR/$SDK_FOLDER" ]; then
            echo "âŒ SDKè§£å‹åè·¯å¾„ä¸å­˜åœ¨ï¼š$SDK_DIR/$SDK_FOLDER"; exit 1;
          fi
          echo "âœ… SDKè§£å‹å®Œæˆï¼Œè·¯å¾„ï¼š$SDK_DIR/$SDK_FOLDER"

      - name: 4. åˆå§‹åŒ–Feedså¹¶åˆ›å»ºè‡ªå®šä¹‰åŒ…ï¼ˆç¡¬ç¼–ç è·¯å¾„ï¼‰
        run: |
          RUNNER_HOME="/home/runner"
          PKG_NAME="luci-app-hello"
          SDK_DIR="$RUNNER_HOME/openwrt-sdk-filogic"
          SDK_FOLDER="openwrt-sdk-24.10.2-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64"
          FULL_SDK_PATH="$SDK_DIR/$SDK_FOLDER"

          # éªŒè¯è·¯å¾„å¹¶è¿›å…¥SDKç›®å½•ï¼ˆå…³é”®ï¼šæå‰ç¡®è®¤è·¯å¾„å­˜åœ¨ï¼‰
          echo "ğŸ” å‡†å¤‡è¿›å…¥SDKè·¯å¾„ï¼š$FULL_SDK_PATH"
          if [ ! -d "$FULL_SDK_PATH" ]; then
            echo "âŒ SDKè·¯å¾„ä¸å­˜åœ¨ï¼å½“å‰ç›®å½•ä¸‹æ–‡ä»¶ï¼š"; ls -l "$SDK_DIR"; exit 1;
          fi
          cd "$FULL_SDK_PATH" || { echo "âŒ è¿›å…¥SDKç›®å½•å¤±è´¥ï¼Œè·¯å¾„ï¼š$FULL_SDK_PATH"; exit 1; }

          # åˆå§‹åŒ–Feeds
          > feeds.conf.default
          echo 'src-git base https://github.com/openwrt/openwrt.git;openwrt-24.10' >> feeds.conf.default
          echo 'src-git packages https://github.com/openwrt/packages.git;master' >> feeds.conf.default
          echo 'src-git luci https://github.com/openwrt/luci.git;openwrt-24.10' >> feeds.conf.default
          ./scripts/feeds update -a || { echo "âŒ Feedsæ›´æ–°å¤±è´¥"; exit 1; }
          ./scripts/feeds install -a || { echo "âŒ Feedså®‰è£…å¤±è´¥"; exit 1; }

          # åˆ›å»ºè‡ªå®šä¹‰åŒ…æ–‡ä»¶
          PKG_BASE_DIR="package/$PKG_NAME"
          CONTROLLER_DIR="$PKG_BASE_DIR/files/usr/lib/lua/luci/controller"
          VIEW_DIR="$PKG_BASE_DIR/files/usr/lib/lua/luci/view/hello"
          mkdir -p "$CONTROLLER_DIR" "$VIEW_DIR"

          # å†™å…¥æ§åˆ¶å™¨
          cat > "$CONTROLLER_DIR/hello.lua" << 'EOF'
          module("luci.controller.hello", package.seeall)
          function index()
              entry({"admin", "system", "hello"}, template("hello/index"), "Hello World", 100)
          end
          EOF

          # å†™å…¥æ¨¡æ¿
          cat > "$VIEW_DIR/index.htm" << 'EOF'
          <%+header%>
          <div style="padding: 20px; font-family: sans-serif;">
              <h2 style="color: #2c3e50;">Hello World!</h2>
              <p style="color: #7f8c8d;">ä»“åº“ï¼šluci-app-build | OpenWRT 24.10.2</p>
              <p style="color: #3498db;">å½“å‰æ—¶é—´ï¼š<%=os.date("%Y-%m-%d %H:%M:%S")%></p>
              <p style="color: #27ae60;">è¿è¡Œè®¾å¤‡ï¼š<%=luci.sys.hostname()%></p>
          </div>
          <%+footer%>
          EOF

          # å†™å…¥Makefile
          cat > "$PKG_BASE_DIR/Makefile" << 'EOF'
          include $(TOPDIR)/rules.mk
          PKG_NAME:=luci-app-hello
          PKG_VERSION:=1.0
          PKG_RELEASE:=1
          include $(INCLUDE_DIR)/package.mk
          include $(TOPDIR)/feeds/luci/luci.mk

          define Package/$(PKG_NAME)
          	SECTION:=luci
          	CATEGORY:=LuCI
          	SUBMENU:=3. System
          	TITLE:=LuCI Hello World
          	DEPENDS:=+luci-base
          	PKGARCH:=all
          endef

          define Package/$(PKG_NAME)/description
          	Simple Hello World (from luci-app-build repo)
          endef

          define Build/Compile
          endef

          define Package/$(PKG_NAME)/install
          	$(INSTALL_DIR) $(1)/usr/lib/lua/luci/controller
          	$(INSTALL_DIR) $(1)/usr/lib/lua/luci/view/hello
          	$(CP) ./files/usr/lib/lua/luci/controller/hello.lua $(1)/usr/lib/lua/luci/controller/
          	$(CP) ./files/usr/lib/lua/luci/view/hello/index.htm $(1)/usr/lib/lua/luci/view/hello/
          endef

          $(eval $(call BuildPackage,$(PKG_NAME)))
          EOF

      - name: 5. ç¼–è¯‘IPKï¼ˆç¡¬ç¼–ç è·¯å¾„ï¼‰
        run: |
          RUNNER_HOME="/home/runner"
          PKG_NAME="luci-app-hello"
          SDK_DIR="$RUNNER_HOME/openwrt-sdk-filogic"
          SDK_FOLDER="openwrt-sdk-24.10.2-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64"
          OUTPUT_DIR="$RUNNER_HOME/luci-hello-ipk"
          FULL_SDK_PATH="$SDK_DIR/$SDK_FOLDER"

          # è¿›å…¥SDKç›®å½•
          cd "$FULL_SDK_PATH" || { echo "âŒ è¿›å…¥SDKç›®å½•å¤±è´¥"; exit 1; }

          # è¡¥å…¨é…ç½®
          if [ ! -f ".config" ]; then
            make defconfig
          fi
          echo "CONFIG_PACKAGE_luci-base=y" >> .config
          echo "CONFIG_PACKAGE_uhttpd=y" >> .config
          echo "CONFIG_PACKAGE_lua=y" >> .config
          echo "CONFIG_PACKAGE_libiwinfo=y" >> .config
          echo "CONFIG_PACKAGE_$PKG_NAME=y" >> .config
          make defconfig || { echo "âŒ é…ç½®ç”Ÿæˆå¤±è´¥"; exit 1; }

          # ç¼–è¯‘
          make package/$PKG_NAME/clean V=s || { echo "âš ï¸  æ— æ—§äº§ç‰©å¯æ¸…ç†"; }
          make package/$PKG_NAME/compile V=s -j1 || { echo "âŒ ç¼–è¯‘å¤±è´¥"; exit 1; }

          # å¤åˆ¶IPK
          mkdir -p "$OUTPUT_DIR"
          ARCH_DIR=$(find "bin/packages/" -maxdepth 1 -type d ! -name "*.ipk" ! -name "packages" | head -n1)
          IPK_PATH=$(find "$ARCH_DIR/" | grep "$PKG_NAME")
          if [ -z "$IPK_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ°IPKæ–‡ä»¶"; exit 1;
          fi
          cp -f "$IPK_PATH" "$OUTPUT_DIR/"
          echo "âœ… ç¼–è¯‘å®Œæˆï¼IPKè·¯å¾„ï¼š$OUTPUT_DIR/$(basename $IPK_PATH)"

      - name: 6. ä¸Šä¼ IPKäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-hello-ipk-from-luci-app-build
          # ç¡¬ç¼–ç äº§ç‰©è·¯å¾„ï¼Œç¡®ä¿æ­£ç¡®
          path: /home/runner/luci-hello-ipk/luci-app-hello_*.ipk
          retention-days: 30
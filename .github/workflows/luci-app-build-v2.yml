name: LuCIç¼–è¯‘-Matrixï¼ˆOpenWRT 24.10.2ï¼‰

on:
  workflow_dispatch:
    inputs:
      verbose:
        description: 'æ˜¯å¦è¾“å‡ºè¯¦ç»†ç¼–è¯‘æ—¥å¿—ï¼ˆV=sï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
  # push:
  #   paths:
  #     - 'luci-app-*/**'

jobs:
  detect:
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.pkg_matrix }}
    steps:
      - name: 1ï¸âƒ£ Checkout ä»“åº“
        uses: actions/checkout@v4

      - name: 2ï¸âƒ£ è¯†åˆ« luci-app-* åŒ…å¹¶è®¾ç½® Matrix
        id: set-matrix
        run: |
          echo "ğŸ“¦ æ­£åœ¨è¯†åˆ« luci-app-* åŒ…..."
          # æŸ¥æ‰¾æ‰€æœ‰ç›´æ¥å­ç›®å½•ä¸‹çš„ luci-app-* æ–‡ä»¶å¤¹
          PKG_LIST=$(find . -maxdepth 1 -type d -name "luci-app-*")
          MATRIX_JSON="{\"pkg\":["

          FIRST=true
          for PKG in $PKG_LIST; do
            PKG_NAME=$(basename "$PKG")
            if [ "$PKG_NAME" = "luci-app-hello" ]; then
              echo "ğŸš« è·³è¿‡é»˜è®¤åŒ…ï¼š$PKG_NAME"
              continue
            fi
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              MATRIX_JSON+=","
            fi
            MATRIX_JSON+="\"$PKG_NAME\""
          done
          MATRIX_JSON+="]}"
          echo "âœ… Matrix JSON: $MATRIX_JSON"
          echo "pkg_matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

  build:
    needs: detect
    runs-on: ubuntu-22.04
    strategy:
      matrix: ${{ fromJson(needs.detect.outputs.matrix) }}
    name: ç¼–è¯‘ ${{ matrix.pkg }}
    steps:
      - name: 1ï¸âƒ£ Checkout ä»“åº“
        uses: actions/checkout@v4

      - name: 2ï¸âƒ£ å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update -y || true
          sudo apt install -y \
            build-essential git wget tar zstd xz-utils \
            python3 python3-dev python3-setuptools swig

      - name: 3ï¸âƒ£ ä¸‹è½½å¹¶è§£å‹ OpenWRT SDK (åŠ¨æ€è·¯å¾„æŸ¥æ‰¾)
        id: sdk-setup
        run: |
          RUNNER_HOME="/home/runner"
          SDK_URL="https://downloads.openwrt.org/releases/24.10.2/targets/mediatek/filogic/openwrt-sdk-24.10.2-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          SDK_TAR="openwrt-sdk-24.10.2.tar.zst"
          SDK_DIR="$RUNNER_HOME/openwrt-sdk-filogic"

          mkdir -p "$SDK_DIR" && cd "$SDK_DIR"
          echo "ğŸ” å½“å‰SDKç›®å½•ï¼š$SDK_DIR"

          # ä¸‹è½½
          if [ ! -f "$SDK_TAR" ]; then
            wget "$SDK_URL" -O "$SDK_TAR" || { echo "âŒ SDKä¸‹è½½å¤±è´¥"; exit 1; }
          fi

          # è§£å‹ .zst
          if [ ! -f "${SDK_TAR%.zst}" ]; then
            zstd -d "$SDK_TAR" || { echo "âŒ ZSTDè§£å‹å¤±è´¥"; exit 1; }
          fi
          # è§£å‹ .tar
          tar -xf "${SDK_TAR%.zst}" || { echo "âŒ TARè§£å‹å¤±è´¥"; exit 1; }

          # åŠ¨æ€æŸ¥æ‰¾è§£å‹åç”Ÿæˆçš„ç›®å½•å
          SDK_FOLDER=$(find . -maxdepth 1 -type d -name "openwrt-sdk-*" -print -quit)

          if [ -z "$SDK_FOLDER" ] || [ ! -d "$SDK_FOLDER" ]; then
            echo "âŒ SDKè§£å‹åè·¯å¾„ä¸å­˜åœ¨ï¼"; ls -l .; exit 1;
          fi

          FULL_SDK_PATH="$SDK_DIR/$SDK_FOLDER"
          echo "âœ… SDKè§£å‹å®Œæˆï¼Œè·¯å¾„ï¼š$FULL_SDK_PATH"
          echo "FULL_SDK_PATH=$FULL_SDK_PATH" >> "$GITHUB_ENV" # å¯¼å‡ºåˆ°ç¯å¢ƒ

      - name: 4ï¸âƒ£ ç¼–è¯‘ ${{ matrix.pkg }}
        run: |
          FULL_SDK_PATH="${{ env.FULL_SDK_PATH }}"
          # æ¯ä¸ªåŒ…çš„è¾“å‡ºç›®å½•ç‹¬ç«‹ï¼Œé¿å…å†²çª
          OUTPUT_DIR="/home/runner/luci-build-ipk/${{ matrix.pkg }}"
          PKG_NAME="${{ matrix.pkg }}"

          VERBOSE_FLAG=""
          if [ "${{ github.event.inputs.verbose }}" = "true" ]; then
            VERBOSE_FLAG="V=s"
          fi

          cd "$FULL_SDK_PATH" || { echo "âŒ è¿›å…¥SDKç›®å½•å¤±è´¥"; exit 1; }

          # ğŸŒŸ Feeds é…ç½®ï¼šæ¢å¤ base feed ä»¥ç¡®ä¿ä¾èµ–å®Œæ•´
          > feeds.conf.default
          echo 'src-git base https://github.com/openwrt/openwrt.git;openwrt-24.10' >> feeds.conf.default
          echo 'src-git packages https://github.com/openwrt/packages.git;master' >> feeds.conf.default
          echo 'src-git luci https://github.com/openwrt/luci.git;openwrt-24.10' >> feeds.conf.default

          ./scripts/feeds update -a || { echo "âŒ Feedsæ›´æ–°å¤±è´¥"; exit 1; }
          ./scripts/feeds install -a || { echo "âŒ Feedså®‰è£…å¤±è´¥"; exit 1; }

          # å¤åˆ¶åº”ç”¨åŒ…
          mkdir -p "$OUTPUT_DIR"
          cp -r "$GITHUB_WORKSPACE/$PKG_NAME" package/

          # é…ç½®
          echo "CONFIG_PACKAGE_$PKG_NAME=y" >> .config
          make defconfig || { echo "âŒ é…ç½®ç”Ÿæˆå¤±è´¥"; exit 1; }

          # ç¼–è¯‘
          make package/$PKG_NAME/clean $VERBOSE_FLAG || echo "âš ï¸ æ— æ—§äº§ç‰©"
          make package/$PKG_NAME/compile $VERBOSE_FLAG -j$(nproc) || { echo "âŒ ç¼–è¯‘å¤±è´¥"; exit 1; } # ğŸŒŸ ä½¿ç”¨å¹¶è¡Œç¼–è¯‘

          # æŸ¥æ‰¾å¹¶å¤åˆ¶ IPK
          ARCH_DIR=$(find "bin/packages/" -maxdepth 1 -type d ! -name "*.ipk" ! -name "packages" | head -n1)
          IPK_PATH=$(find "$ARCH_DIR/" -name "*$PKG_NAME*.ipk" | head -n1)

          if [ -z "$IPK_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ° $PKG_NAME çš„ IPK æ–‡ä»¶ï¼"; ls -l "$ARCH_DIR"; exit 1;
          fi

          cp -f "$IPK_PATH" "$OUTPUT_DIR/"
          echo "âœ… ç¼–è¯‘å®Œæˆï¼IPKè·¯å¾„ï¼š$OUTPUT_DIR/$(basename $IPK_PATH)"

      - name: 5ï¸âƒ£ ä¸Šä¼  IPK äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          # ä¸Šä¼  Artifact åç§°ä½¿ç”¨åŒ…åï¼Œä»¥ä¾¿ Release Job åŒºåˆ†ä¸‹è½½
          name: ${{ matrix.pkg }}-ipk
          # è·¯å¾„æŒ‡å‘ç‹¬ç«‹è¾“å‡ºç›®å½•ä¸‹çš„ IPK æ–‡ä»¶
          path: /home/runner/luci-build-ipk/${{ matrix.pkg }}/*.ipk
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-22.04
    steps:
      - name: 1ï¸âƒ£ ä¸‹è½½æ‰€æœ‰ IPK äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          # ä¸‹è½½åˆ° /home/runner/all-ipksï¼Œç»“æ„ä¸º all-ipks/<pkg_name>-ipk/*.ipk
          path: /home/runner/all-ipks

      - name: 2ï¸âƒ£ è®¾ç½®å½“å‰æ—¶é—´
        run: |
          echo "BUILD_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S CST')" >> $GITHUB_ENV
          echo "VERSION_TAG=$(TZ='Asia/Shanghai' date '+%Y%m%d%H%M')" >> $GITHUB_ENV

      - name: 3ï¸âƒ£ ç”ŸæˆåŒ…åˆ—è¡¨
        run: |
          # æŸ¥æ‰¾æ‰€æœ‰å­ç›®å½•ï¼ˆå³ Artifacts çš„åç§°ï¼‰å¹¶æ ¼å¼åŒ–ä¸ºåˆ—è¡¨
          PKG_NAMES=$(find /home/runner/all-ipks -mindepth 1 -maxdepth 1 -type d | sed 's/.*\///' | sed 's/-ipk$//' | tr '\n' ',' | sed 's/,$//')
          echo "PKG_NAMES=$PKG_NAMES" >> $GITHUB_ENV

      - name: 4ï¸âƒ£ å‘å¸ƒåˆ° GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "all-build-${{ env.VERSION_TAG }}"
          name: "è‡ªåŠ¨ç¼–è¯‘ LuCI åº”ç”¨åŒ…"
          # files å¿…é¡»ä½¿ç”¨é€šé…ç¬¦æ¥åŒ¹é…æ‰€æœ‰å­ç›®å½•ä¸­çš„æ‰€æœ‰ IPK æ–‡ä»¶
          files: /home/runner/all-ipks/**/*.ipk
          body: |
            ğŸ‰ æ‰€æœ‰åŒ…ç¼–è¯‘å®Œæˆï¼
            åŒ…åˆ—è¡¨ï¼š${{ env.PKG_NAMES }}
            æ—¶é—´ï¼š${{ env.BUILD_TIME }}
<%+header%>
<h2>Smart æ¨¡å‹æ›´æ–°</h2>

<!-- çŠ¶æ€æ  -->
<div id="status-banner" style="
	display: flex;
	align-items: center;
	justify-content: space-between;
	background-color: #f0f8ff; /* ä¸­æ€§è“ç°èƒŒæ™¯ */
	border-left: 6px solid #007bff; /* è“è‰²è¾¹æ¡† */
	padding: 10px 15px;
	margin: 10px 0 20px 0;
	border-radius: 6px;
	font-size: 1.1em;
	font-weight: bold;
	color: #333;
	box-shadow: 0 2px 4px rgba(0,0,0,0.05);
">
	<span id="status-label">ğŸ”µ å½“å‰çŠ¶æ€ï¼š<span id="status-text"><%=status%></span></span>
	<button type="button" id="stop-btn" class="cbi-button cbi-button-remove" style="display:none;" onclick="stopUpdate()">åœæ­¢è¿è¡Œ</button>
</div>

<!-- è¡¨å•åŒºåŸŸ -->
<div class="cbi-section">
	<form method="post" style="padding-top: 5px; padding-bottom: 16px;">
		<fieldset class="cbi-section" style="
			background-color: #ffffff;
			padding-top: 10px;
			padding-left: 10px;
			box-shadow: 0 2px 6px rgba(0,0,0,0.05);
		">
			<legend style="font-weight: bold; font-size: 1.1em;">Git é…ç½®</legend>

			<!-- Git åœ°å€ -->
			<div class="cbi-value" style="display:flex; align-items:center; gap:10px; margin-bottom:16px; padding-bottom:8px; border-bottom: 1px solid #eee; max-width: 50rem;">
				<label for="git_path" style="min-width:120px;">ä»“åº“ Git åœ°å€ï¼š</label>
				<input type="text" id="git_path" name="git_path" value="<%=git_path or ''%>" style="flex:1;" />
			</div>

			<!-- Git ç”¨æˆ·å -->
			<div class="cbi-value" style="display:flex; align-items:center; gap:10px; margin-bottom:16px; padding-bottom:8px; border-bottom: 1px solid #eee; max-width: 50rem;">
				<label for="git_user" style="min-width:120px;">Git ç”¨æˆ·åï¼š</label>
				<input type="text" id="git_user" name="git_user" value="<%=git_user or ''%>" style="flex:1;" />
			</div>

			<!-- Git é‚®ç®± -->
			<div class="cbi-value" style="display:flex; align-items:center; gap:10px; margin-bottom:16px; padding-bottom:8px; border-bottom: 1px solid #eee; max-width: 50rem;">
				<label for="git_email" style="min-width:120px;">Git é‚®ç®±åœ°å€ï¼š</label>
				<input type="text" id="git_email" name="git_email" value="<%=git_email or ''%>" style="flex:1;" />
			</div>

			<!-- å®šæ—¶ä»»åŠ¡ -->
			<div class="cbi-value" style="display:flex; align-items:center; gap:10px; margin-bottom:16px; padding-bottom:8px; border-bottom: 1px solid #eee; max-width: 50rem;">
				<label for="preset_schedule" style="min-width:120px;">é¢„è®¾æ—¶é—´ï¼š</label>
				<select id="preset_schedule" name="preset_schedule" style="flex:1;">
					<option value="">æ— ï¼ˆä¸å¯ç”¨å®šæ—¶ä»»åŠ¡ï¼‰</option>
					<option value="0 0 * * *" <%=cron_schedule == "0 0 * * *" and "selected" or ""%>>æ¯å¤©å‡Œæ™¨ 0 ç‚¹</option>
					<option value="0 3 * * *" <%=cron_schedule == "0 3 * * *" and "selected" or ""%>>æ¯å¤©å‡Œæ™¨ 3 ç‚¹</option>
					<option value="0 6 * * *" <%=cron_schedule == "0 6 * * *" and "selected" or ""%>>æ¯å¤©å‡Œæ™¨ 6 ç‚¹</option>
					<option value="0 9 * * *" <%=cron_schedule == "0 9 * * *" and "selected" or ""%>>æ¯å¤©ä¸Šåˆ 9 ç‚¹</option>
					<option value="0 12 * * *" <%=cron_schedule == "0 12 * * *" and "selected" or ""%>>æ¯å¤©ä¸­åˆ 12 ç‚¹</option>
					<option value="0 15 * * *" <%=cron_schedule == "0 15 * * *" and "selected" or ""%>>æ¯å¤©ä¸‹åˆ 15 ç‚¹</option>
					<option value="0 18 * * *" <%=cron_schedule == "0 18 * * *" and "selected" or ""%>>æ¯å¤©å‚æ™š 18 ç‚¹</option>
					<option value="0 21 * * *" <%=cron_schedule == "0 21 * * *" and "selected" or ""%>>æ¯å¤©æ™šä¸Š 21 ç‚¹</option>
					<option value="0 0 * * 1" <%=cron_schedule == "0 0 * * 1" and "selected" or ""%>>æ¯å‘¨ä¸€å‡Œæ™¨</option>
					<option value="0 0 * * 2" <%=cron_schedule == "0 0 * * 2" and "selected" or ""%>>æ¯å‘¨äºŒå‡Œæ™¨</option>
					<option value="0 0 * * 3" <%=cron_schedule == "0 0 * * 3" and "selected" or ""%>>æ¯å‘¨ä¸‰å‡Œæ™¨</option>
					<option value="0 0 * * 4" <%=cron_schedule == "0 0 * * 4" and "selected" or ""%>>æ¯å‘¨å››å‡Œæ™¨</option>
					<option value="0 0 * * 5" <%=cron_schedule == "0 0 * * 5" and "selected" or ""%>>æ¯å‘¨äº”å‡Œæ™¨</option>
					<option value="0 0 * * 6" <%=cron_schedule == "0 0 * * 6" and "selected" or ""%>>æ¯å‘¨å…­å‡Œæ™¨</option>
					<option value="0 0 * * 0" <%=cron_schedule == "0 0 * * 0" and "selected" or ""%>>æ¯å‘¨æ—¥å‡Œæ™¨</option>
				</select>
			</div>

			<!-- æ‹‰å–æ—¶é—´ -->
			<div class="cbi-value" style="display:flex; align-items:center; gap:10px; margin-bottom:16px; padding-bottom:8px; border-bottom: 1px solid #eee; max-width: 50rem;">
				<label for="pull_time" style="min-width:120px;">æ‹‰å–æ¨¡å‹æ—¶é—´ï¼š</label>
				<select id="pull_time" name="pull_time" style="flex:1;">
					<option value="1" <%=pull_time == "1" and "selected" or ""%>>1 åˆ†é’Ÿ</option>
					<option value="2" <%=pull_time == "2" and "selected" or ""%>>2 åˆ†é’Ÿ</option>
					<option value="3" <%=pull_time == "3" and "selected" or ""%>>3 åˆ†é’Ÿ</option>
					<option value="4" <%=pull_time == "4" and "selected" or ""%>>4 åˆ†é’Ÿ</option>
					<option value="5" <%=pull_time == "5" and "selected" or ""%>>5 åˆ†é’Ÿ</option>
					<option value="6" <%=pull_time == "6" and "selected" or ""%>>6 åˆ†é’Ÿ</option>
					<option value="7" <%=pull_time == "7" and "selected" or ""%>>7 åˆ†é’Ÿ</option>
					<option value="8" <%=pull_time == "8" and "selected" or ""%>>8 åˆ†é’Ÿ</option>
					<option value="9" <%=pull_time == "9" and "selected" or ""%>>9 åˆ†é’Ÿ</option>
					<option value="10" <%=pull_time == "10" and "selected" or ""%>>10 åˆ†é’Ÿ</option>
					<option value="11" <%=pull_time == "11" and "selected" or ""%>>11 åˆ†é’Ÿ</option>
					<option value="12" <%=pull_time == "12" and "selected" or ""%>>12 åˆ†é’Ÿ</option>
					<option value="13" <%=pull_time == "13" and "selected" or ""%>>13 åˆ†é’Ÿ</option>
					<option value="14" <%=pull_time == "14" and "selected" or ""%>>14 åˆ†é’Ÿ</option>
					<option value="15" <%=pull_time == "15" and "selected" or ""%>>15 åˆ†é’Ÿ</option>
					<option value="16" <%=pull_time == "16" and "selected" or ""%>>16 åˆ†é’Ÿ</option>
					<option value="17" <%=pull_time == "17" and "selected" or ""%>>17 åˆ†é’Ÿ</option>
					<option value="18" <%=pull_time == "18" and "selected" or ""%>>18 åˆ†é’Ÿ</option>
					<option value="19" <%=pull_time == "19" and "selected" or ""%>>19 åˆ†é’Ÿ</option>
					<option value="20" <%=pull_time == "20" and "selected" or ""%>>20 åˆ†é’Ÿ</option>
				</select>
			</div>
		</fieldset>

		<!-- æ“ä½œæŒ‰é’® -->
		<fieldset class="cbi-section" style="margin-top:20px;">
			<legend>æ“ä½œ</legend>
			<div class="cbi-value" style="display:flex; gap:10px; align-items:center;">
				<button type="submit" name="run" value="1" class="cbi-button cbi-button-apply">ç«‹å³æ›´æ–°</button>
				<% if pubkey then %>
					<button type="button" class="cbi-button cbi-button-default" onclick="togglePubKey()">æŸ¥çœ‹å…¬é’¥</button>
					<button type="button" id="copy-btn" class="cbi-button cbi-button-default" onclick="copyPubKey()" style="display:none;">å¤åˆ¶å…¬é’¥</button>
				<% end %>
			</div>
			<% if pubkey then %>
				<div id="pubkey-box" style="
					display:none;
					background-color: #fff;
					border: 1px solid #ccc;
					border-radius: 6px;
					padding: 16px;
					margin-top: 10px;
					box-shadow: 0 2px 6px rgba(0,0,0,0.05);
				">
					<textarea id="ssh-pubkey" readonly style="width:100%; height:100px; font-family: monospace;"><%=pubkey%></textarea>
					<p style="margin-top: 8px;">è¯·å°†æ­¤å…¬é’¥æ·»åŠ åˆ° GitHub æˆ–ä½ çš„ Git æœåŠ¡çš„ SSH è®¾ç½®ä¸­ã€‚</p>
				</div>
			<% else %>
				<p>å°šæœªç”Ÿæˆ SSH å¯†é’¥ã€‚</p>
			<% end %>
		</fieldset>
	</form>
</div>

<!-- æ—¥å¿—è¾“å‡º -->
<h3 style="margin-top:20px; display:flex; justify-content:space-between; align-items:center;">
	<span>æ—¥å¿—è¾“å‡º</span>
	<span style="display:flex; gap:10px;">
		<button class="cbi-button cbi-button-apply" onclick="refreshLog()">åˆ·æ–°æ—¥å¿—</button>
		<button class="cbi-button cbi-button-remove" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
	</span>
</h3>

<pre id="log-box" class="cbi-input-textarea" style="
	max-height:400px;
	overflow:auto;
	padding:16px;
	background-color: #1e1e1e;
	color: #d4d4d4;
	font-size: 1rem;
	font-family: monospace;
	border-radius: 6px;
	box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
"><%=log%></pre>

<% if error_msg and error_msg.message then %>
<script>
	alert("<%=error_msg.message%>");
</script>
<% end %>

<!-- å‰ç«¯äº¤äº’è„šæœ¬ -->
<script>
function refreshStatus() {
	// é¦–å…ˆæ£€æŸ¥é¡µé¢ä¸Šæ˜¾ç¤ºçš„å½“å‰çŠ¶æ€
	const currentStatusText = document.getElementById("status-text").textContent.trim();

	// æ ¹æ®é¡µé¢æ˜¾ç¤ºçš„çŠ¶æ€æ›´æ–°æ ·å¼
	updateStatusStyle(currentStatusText);

	// ä»æœåŠ¡å™¨è·å–æœ€æ–°çŠ¶æ€
	fetch('<%=luci.dispatcher.build_url("admin/services/model-update/status")%>')
		.then(response => response.json())
		.then(data => {
			const statusText = document.getElementById("status-text");
			statusText.textContent = data.status;
			// æ ¹æ®æœåŠ¡å™¨è¿”å›çš„çŠ¶æ€æ›´æ–°æ ·å¼
			updateStatusStyle(data.status);
		});
}

// çŠ¶æ€æ ·å¼æ›´æ–°
function updateStatusStyle(status) {
	const statusLabel = document.getElementById("status-label");
	const banner = document.getElementById("status-banner");
	const stopBtn = document.getElementById("stop-btn");

	if (status === "è¿è¡Œä¸­") {
		banner.style.borderLeftColor = "#28a745";
		banner.style.backgroundColor = "#e6ffed";
		statusLabel.innerHTML = "ğŸŸ¢ å½“å‰çŠ¶æ€ï¼š<span id='status-text'>" + status + "</span>";
		stopBtn.style.display = "inline-block";
	} else {
		banner.style.borderLeftColor = "#007bff";
		banner.style.backgroundColor = "#f0f8ff";
		statusLabel.innerHTML = "ğŸ”µ å½“å‰çŠ¶æ€ï¼š<span id='status-text'>" + status + "</span>";
		stopBtn.style.display = "none";
	}
}

// é¡µé¢åŠ è½½å®Œæˆåç«‹å³æ‰§è¡Œä¸€æ¬¡çŠ¶æ€æ£€æŸ¥
document.addEventListener('DOMContentLoaded', function() {
	refreshStatus();
	refreshLog();
});

// ä¿æŒå®šæ—¶åˆ·æ–°
setInterval(refreshStatus, 5000);
setInterval(refreshLog, 5000);

function stopUpdate() {
	if (!confirm("ç¡®å®šè¦åœæ­¢å½“å‰è¿è¡Œçš„æ¨¡å‹æ›´æ–°å—ï¼Ÿ")) return;
	fetch('<%=luci.dispatcher.build_url("admin/services/model-update/stop")%>')
		.then(() => {
			refreshStatus();
			refreshLog();
		});
}

function refreshLog() {
	fetch('<%=luci.dispatcher.build_url("admin/services/model-update/log")%>')
		.then(response => response.json())
		.then(data => {
			document.getElementById("log-box").textContent = data.log;
		});
}

function clearLog() {
	fetch('<%=luci.dispatcher.build_url("admin/services/model-update/clear")%>')
		.then(() => refreshLog());
}

document.querySelector("form").addEventListener("submit", function(e) {
	const gitInput = document.getElementById("git_path");
	const gitPath = gitInput.value.trim();
	const isValidGit = /^((git@|https?:\/\/).+?)(\.git)?$/.test(gitPath);

	if (!gitPath) {
		alert("è¯·å¡«å†™ Git ä»“åº“åœ°å€ï¼");
		gitInput.focus();
		e.preventDefault();
		return false;
	}

	if (!isValidGit) {
		alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ Git ä»“åº“åœ°å€ï¼Œä¾‹å¦‚ï¼šhttps://github.com/user/repo.git æˆ– git@github.com:user/repo.git");
		gitInput.focus();
		e.preventDefault();
		return false;
	}

	const emailInput = document.getElementById("git_email");
	const email = emailInput.value.trim();
	if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
		alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€ï¼");
		emailInput.focus();
		e.preventDefault();
		return false;
	}
});

function togglePubKey() {
	const box = document.getElementById("pubkey-box");
	const copyBtn = document.getElementById("copy-btn");
	const isVisible = box.style.display === "block";
	box.style.display = isVisible ? "none" : "block";
	copyBtn.style.display = isVisible ? "none" : "inline-block";
}

function copyPubKey() {
	const pubKeyBox = document.getElementById("ssh-pubkey");
	pubKeyBox.select();
	pubKeyBox.setSelectionRange(0, pubKeyBox.value.length);
	try {
		const success = document.execCommand("copy");
		if (success) {
			alert("å…¬é’¥å·²å¤åˆ¶ï¼");
		} else {
			alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚");
		}
	} catch (err) {
		alert("æµè§ˆå™¨ä¸æ”¯æŒè‡ªåŠ¨å¤åˆ¶ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚");
	}
}
</script>

<%+footer%>
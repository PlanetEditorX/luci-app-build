<%+header%>
<h2>Smart 模型更新</h2>

<!-- 状态栏 -->
<div id="status-banner" style="
	display: flex;
	align-items: center;
	justify-content: space-between;
	background-color: #f0f8ff; /* 中性蓝灰背景 */
	border-left: 6px solid #007bff; /* 蓝色边框 */
	padding: 10px 15px;
	margin: 10px 0 20px 0;
	border-radius: 6px;
	font-size: 1.1em;
	font-weight: bold;
	color: #333;
	box-shadow: 0 2px 4px rgba(0,0,0,0.05);
">
	<span id="status-label">🔵 当前状态：<span id="status-text"><%=status%></span></span>
	<button type="button" id="stop-btn" class="cbi-button cbi-button-remove" style="display:none;" onclick="stopUpdate()">停止运行</button>
</div>

<!-- 表单区域 -->
<div class="cbi-section">
	<form method="post" style="padding-top: 5px; padding-bottom: 16px;">
		<fieldset class="cbi-section" style="
			background-color: #ffffff;
			padding-top: 10px;
			padding-left: 10px;
			box-shadow: 0 2px 6px rgba(0,0,0,0.05);
		">
			<legend style="font-weight: bold; font-size: 1.1em;">Git 配置</legend>

			<!-- Git 地址 -->
			<div class="cbi-value" style="display:flex; align-items:center; gap:10px; margin-bottom:16px; padding-bottom:8px; border-bottom: 1px solid #eee; max-width: 50rem;">
				<label for="git_path" style="min-width:120px;">仓库 Git 地址：</label>
				<input type="text" id="git_path" name="git_path" value="<%=git_path or ''%>" style="flex:1;" />
			</div>

			<!-- Git 用户名 -->
			<div class="cbi-value" style="display:flex; align-items:center; gap:10px; margin-bottom:16px; padding-bottom:8px; border-bottom: 1px solid #eee; max-width: 50rem;">
				<label for="git_user" style="min-width:120px;">Git 用户名：</label>
				<input type="text" id="git_user" name="git_user" value="<%=git_user or ''%>" style="flex:1;" />
			</div>

			<!-- Git 邮箱 -->
			<div class="cbi-value" style="display:flex; align-items:center; gap:10px; margin-bottom:16px; padding-bottom:8px; border-bottom: 1px solid #eee; max-width: 50rem;">
				<label for="git_email" style="min-width:120px;">Git 邮箱地址：</label>
				<input type="text" id="git_email" name="git_email" value="<%=git_email or ''%>" style="flex:1;" />
			</div>

			<!-- 定时任务 -->
			<div class="cbi-value" style="display:flex; align-items:center; gap:10px; margin-bottom:16px; padding-bottom:8px; border-bottom: 1px solid #eee; max-width: 50rem;">
				<label for="preset_schedule" style="min-width:120px;">预设时间：</label>
				<select id="preset_schedule" name="preset_schedule" style="flex:1;">
					<option value="">无（不启用定时任务）</option>
					<option value="0 0 * * *" <%=cron_schedule == "0 0 * * *" and "selected" or ""%>>每天凌晨 0 点</option>
					<option value="0 3 * * *" <%=cron_schedule == "0 3 * * *" and "selected" or ""%>>每天凌晨 3 点</option>
					<option value="0 6 * * *" <%=cron_schedule == "0 6 * * *" and "selected" or ""%>>每天凌晨 6 点</option>
					<option value="0 9 * * *" <%=cron_schedule == "0 9 * * *" and "selected" or ""%>>每天上午 9 点</option>
					<option value="0 12 * * *" <%=cron_schedule == "0 12 * * *" and "selected" or ""%>>每天中午 12 点</option>
					<option value="0 15 * * *" <%=cron_schedule == "0 15 * * *" and "selected" or ""%>>每天下午 15 点</option>
					<option value="0 18 * * *" <%=cron_schedule == "0 18 * * *" and "selected" or ""%>>每天傍晚 18 点</option>
					<option value="0 21 * * *" <%=cron_schedule == "0 21 * * *" and "selected" or ""%>>每天晚上 21 点</option>
					<option value="0 0 * * 1" <%=cron_schedule == "0 0 * * 1" and "selected" or ""%>>每周一凌晨</option>
					<option value="0 0 * * 2" <%=cron_schedule == "0 0 * * 2" and "selected" or ""%>>每周二凌晨</option>
					<option value="0 0 * * 3" <%=cron_schedule == "0 0 * * 3" and "selected" or ""%>>每周三凌晨</option>
					<option value="0 0 * * 4" <%=cron_schedule == "0 0 * * 4" and "selected" or ""%>>每周四凌晨</option>
					<option value="0 0 * * 5" <%=cron_schedule == "0 0 * * 5" and "selected" or ""%>>每周五凌晨</option>
					<option value="0 0 * * 6" <%=cron_schedule == "0 0 * * 6" and "selected" or ""%>>每周六凌晨</option>
					<option value="0 0 * * 0" <%=cron_schedule == "0 0 * * 0" and "selected" or ""%>>每周日凌晨</option>
				</select>
			</div>
		</fieldset>

		<!-- 操作按钮 -->
		<fieldset class="cbi-section" style="margin-top:20px;">
			<legend>操作</legend>
			<div class="cbi-value" style="display:flex; gap:10px; align-items:center;">
				<button type="submit" name="run" value="1" class="cbi-button cbi-button-apply">立即更新</button>
				<% if pubkey then %>
					<button type="button" class="cbi-button cbi-button-default" onclick="togglePubKey()">查看公钥</button>
					<button type="button" id="copy-btn" class="cbi-button cbi-button-default" onclick="copyPubKey()" style="display:none;">复制公钥</button>
				<% end %>
			</div>
			<% if pubkey then %>
				<div id="pubkey-box" style="
					display:none;
					background-color: #fff;
					border: 1px solid #ccc;
					border-radius: 6px;
					padding: 16px;
					margin-top: 10px;
					box-shadow: 0 2px 6px rgba(0,0,0,0.05);
				">
					<textarea id="ssh-pubkey" readonly style="width:100%; height:100px; font-family: monospace;"><%=pubkey%></textarea>
					<p style="margin-top: 8px;">请将此公钥添加到 GitHub 或你的 Git 服务的 SSH 设置中。</p>
				</div>
			<% else %>
				<p>尚未生成 SSH 密钥。</p>
			<% end %>
		</fieldset>
	</form>
</div>

<!-- 日志输出 -->
<h3 style="margin-top:20px; display:flex; justify-content:space-between; align-items:center;">
	<span>日志输出</span>
	<span style="display:flex; gap:10px;">
		<button class="cbi-button cbi-button-apply" onclick="refreshLog()">刷新日志</button>
		<button class="cbi-button cbi-button-remove" onclick="clearLog()">清空日志</button>
	</span>
</h3>

<pre id="log-box" class="cbi-input-textarea" style="
	max-height:400px;
	overflow:auto;
	padding:16px;
	background-color: #1e1e1e;
	color: #d4d4d4;
	font-size: 1rem;
	font-family: monospace;
	border-radius: 6px;
	box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
"><%=log%></pre>

<% if error_msg and error_msg.message then %>
<script>
	alert("<%=error_msg.message%>");
</script>
<% end %>

<!-- 前端交互脚本 -->
<script>
function refreshStatus() {
	// 首先检查页面上显示的当前状态
	const currentStatusText = document.getElementById("status-text").textContent.trim();

	// 根据页面显示的状态更新样式
	updateStatusStyle(currentStatusText);

	// 从服务器获取最新状态
	fetch('<%=luci.dispatcher.build_url("admin/services/model-update/status")%>')
		.then(response => response.json())
		.then(data => {
			const statusText = document.getElementById("status-text");
			statusText.textContent = data.status;
			// 根据服务器返回的状态更新样式
			updateStatusStyle(data.status);
		});
}

// 状态样式更新
function updateStatusStyle(status) {
	const statusLabel = document.getElementById("status-label");
	const banner = document.getElementById("status-banner");
	const stopBtn = document.getElementById("stop-btn");

	if (status === "运行中") {
		banner.style.borderLeftColor = "#28a745";
		banner.style.backgroundColor = "#e6ffed";
		statusLabel.innerHTML = "🟢 当前状态：<span id='status-text'>" + status + "</span>";
		stopBtn.style.display = "inline-block";
	} else {
		banner.style.borderLeftColor = "#007bff";
		banner.style.backgroundColor = "#f0f8ff";
		statusLabel.innerHTML = "🔵 当前状态：<span id='status-text'>" + status + "</span>";
		stopBtn.style.display = "none";
	}
}

// 页面加载完成后立即执行一次状态检查
document.addEventListener('DOMContentLoaded', function() {
	refreshStatus();
	refreshLog();
});

// 保持定时刷新
setInterval(refreshStatus, 5000);
setInterval(refreshLog, 5000);

function stopUpdate() {
	if (!confirm("确定要停止当前运行的模型更新吗？")) return;
	fetch('<%=luci.dispatcher.build_url("admin/services/model-update/stop")%>')
		.then(() => {
			refreshStatus();
			refreshLog();
		});
}

function refreshLog() {
	fetch('<%=luci.dispatcher.build_url("admin/services/model-update/log")%>')
		.then(response => response.json())
		.then(data => {
			document.getElementById("log-box").textContent = data.log;
		});
}

function clearLog() {
	fetch('<%=luci.dispatcher.build_url("admin/services/model-update/clear")%>')
		.then(() => refreshLog());
}

document.querySelector("form").addEventListener("submit", function(e) {
	const gitInput = document.getElementById("git_path");
	const gitPath = gitInput.value.trim();
	const isValidGit = /^((git@|https?:\/\/).+?)(\.git)?$/.test(gitPath);

	if (!gitPath) {
		alert("请填写 Git 仓库地址！");
		gitInput.focus();
		e.preventDefault();
		return false;
	}

	if (!isValidGit) {
		alert("请输入有效的 Git 仓库地址，例如：https://github.com/user/repo.git 或 git@github.com:user/repo.git");
		gitInput.focus();
		e.preventDefault();
		return false;
	}

	const emailInput = document.getElementById("git_email");
	const email = emailInput.value.trim();
	if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
		alert("请输入有效的邮箱地址！");
		emailInput.focus();
		e.preventDefault();
		return false;
	}
});

function togglePubKey() {
	const box = document.getElementById("pubkey-box");
	const copyBtn = document.getElementById("copy-btn");
	const isVisible = box.style.display === "block";
	box.style.display = isVisible ? "none" : "block";
	copyBtn.style.display = isVisible ? "none" : "inline-block";
}

function copyPubKey() {
	const pubKeyBox = document.getElementById("ssh-pubkey");
	pubKeyBox.select();
	pubKeyBox.setSelectionRange(0, pubKeyBox.value.length);
	try {
		const success = document.execCommand("copy");
		if (success) {
			alert("公钥已复制！");
		} else {
			alert("复制失败，请手动复制。");
		}
	} catch (err) {
		alert("浏览器不支持自动复制，请手动复制。");
	}
}
</script>

<%+footer%>
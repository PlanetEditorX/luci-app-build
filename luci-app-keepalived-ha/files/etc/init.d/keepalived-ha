#!/bin/sh /etc/rc.common

START=99
STOP=10

# 初始化配置文件（确保所有必要的节和选项存在）
init_config() {
    local CONF="/etc/config/keepalived-ha"
    local section_exists

    # 确保配置文件存在
    [ -f "$CONF" ] || touch "$CONF"

    # 检查并添加general节
    section_exists=$(uci -q get keepalived-ha.general)
    if [ -z "$section_exists" ]; then
        uci set keepalived-ha.general=general
        uci set keepalived-ha.general.role='main'  # 默认角色
        uci set keepalived-ha.general.vip='192.168.1.5'
        uci set keepalived-ha.general.interface='br-lan'
        uci set keepalived-ha.general.check_method='ping'
        uci set keepalived-ha.general.vrid='51'
        uci set keepalived-ha.general.advanced_mode='0'
        uci set keepalived-ha.general.preempt='true'
        uci set keepalived-ha.general.control_openclash='1'
    else
        # 确保general节的所有必要选项存在
        uci -q get keepalived-ha.general.role || uci set keepalived-ha.general.role='main'
        uci -q get keepalived-ha.general.vip || uci set keepalived-ha.general.vip='192.168.1.5'
        uci -q get keepalived-ha.general.interface || uci set keepalived-ha.general.interface='br-lan'
        uci -q get keepalived-ha.general.check_method || uci set keepalived-ha.general.check_method='ping'
        uci -q get keepalived-ha.general.vrid || uci set keepalived-ha.general.vrid='51'
        uci -q get keepalived-ha.general.advanced_mode || uci set keepalived-ha.general.advanced_mode='0'
        uci -q get keepalived-ha.general.preempt || uci set keepalived-ha.general.preempt='true'
        uci -q get keepalived-ha.general.control_openclash || uci set keepalived-ha.general.control_openclash='1'
    fi

    # 检查并添加main节（主路由配置）
    section_exists=$(uci -q get keepalived-ha.main)
    if [ -z "$section_exists" ]; then
        uci set keepalived-ha.main=main
        uci set keepalived-ha.main.peer_ip='192.168.1.3'
        uci set keepalived-ha.main.priority='50'
        uci set keepalived-ha.main.fail_threshold='3'
        uci set keepalived-ha.main.recover_threshold='2'
        uci set keepalived-ha.main.check_interval='5'
    else
        # 确保main节的所有必要选项存在
        uci -q get keepalived-ha.main.peer_ip || uci set keepalived-ha.main.peer_ip='192.168.1.3'
        uci -q get keepalived-ha.main.priority || uci set keepalived-ha.main.priority='50'
        uci -q get keepalived-ha.main.fail_threshold || uci set keepalived-ha.main.fail_threshold='3'
        uci -q get keepalived-ha.main.recover_threshold || uci set keepalived-ha.main.recover_threshold='2'
        uci -q get keepalived-ha.main.check_interval || uci set keepalived-ha.main.check_interval='5'
    fi

    # 检查并添加peer节（从路由配置）
    section_exists=$(uci -q get keepalived-ha.peer)
    if [ -z "$section_exists" ]; then
        uci set keepalived-ha.peer=peer
        uci set keepalived-ha.peer.main_ip='192.168.1.2'
        uci set keepalived-ha.peer.priority='100'
    else
        # 确保peer节的所有必要选项存在
        uci -q get keepalived-ha.peer.main_ip || uci set keepalived-ha.peer.main_ip='192.168.1.2'
        uci -q get keepalived-ha.peer.priority || uci set keepalived-ha.peer.priority='100'
    fi

    # 只有在有修改时才提交，避免不必要的配置变动
    if uci -q changes keepalived-ha; then
        uci commit keepalived-ha
    fi
}

start() {
    init_config  # 启动时确保配置初始化
    # 其他启动逻辑（如启动keepalived、监控脚本等）
    echo "Starting keepalived-ha service..."
    /etc/keepalived/keepalived_boot.sh &
}

stop() {
    # 停止逻辑
    echo "Stopping keepalived-ha service..."
    pkill -f "keepalived"
    pkill -f "failover_watchdog.sh"
}

restart() {
    stop
    start
}

#!/bin/sh /etc/rc.common

START=99
STOP=10

# 初始化配置文件（确保所有必要的节存在）
init_config() {
    local CONF="/etc/config/keepalived-ha"

    # 确保配置文件存在
    [ -f "$CONF" ] || touch "$CONF"

    # 检查并添加general节
    if ! uci -q get keepalived-ha.general; then
        uci set keepalived-ha.general=general
        uci set keepalived-ha.general.role='main'  # 默认角色
        uci set keepalived-ha.general.vip='192.168.1.5'
        uci set keepalived-ha.general.interface='br-lan'
    fi

    # 检查并添加main节（主路由配置）
    if ! uci -q get keepalived-ha.main; then
        uci set keepalived-ha.main=main
        uci set keepalived-ha.main.peer_ip='192.168.1.3'
        uci set keepalived-ha.main.priority='50'
        uci set keepalived-ha.main.fail_threshold='3'
        uci set keepalived-ha.main.recover_threshold='2'
        uci set keepalived-ha.main.check_interval='5'
    fi

    # 检查并添加peer节（旁路由配置）
    if ! uci -q get keepalived-ha.peer; then
        uci set keepalived-ha.peer=peer
        uci set keepalived-ha.peer.main_ip='192.168.1.2'
        uci set keepalived-ha.peer.priority='100'
    fi

    uci commit keepalived-ha
}

start() {
    init_config  # 启动时确保配置初始化
    # 其他启动逻辑（如启动keepalived、监控脚本等）
    echo "Starting keepalived-ha service..."
    /etc/keepalived/keepalived_boot.sh &
}

stop() {
    # 停止逻辑
    echo "Stopping keepalived-ha service..."
    pkill -f "keepalived"
    pkill -f "failover_watchdog.sh"
}

restart() {
    stop
    start
}

#!/bin/sh /etc/rc.common
START=90
STOP=10

USE_PROCD=1
PROG=/usr/sbin/keepalived

# 读取UCI配置
read_config() {
    config_load keepalived-ha
    config_get role general role "main"
    config_get vip general vip "192.168.1.5"
    config_get interface general interface "br-lan"

    if [ "$role" = "main" ]; then
        config_get peer_ip main peer_ip "192.168.1.3"
        config_get priority main priority "50"
        config_get fail_threshold main fail_threshold "3"
        config_get recover_threshold main recover_threshold "2"
        config_get check_interval main check_interval "5"
    else
        config_get main_ip peer main_ip "192.168.1.2"
        config_get priority peer priority "100"
    fi
}

# 生成配置文件
generate_config() {
    if [ "$role" = "main" ]; then
        sed \
            -e "s|@INTERFACE@|$interface|g" \
            -e "s|@PRIORITY@|$priority|g" \
            -e "s|@VIP@|$vip|g" \
            /etc/keepalived/template/keepalived_main.conf > /tmp/keepalived.conf

        # 替换监控脚本变量
        sed -i \
            -e "s|@VIP@|$vip|g" \
            -e "s|@INTERFACE@|$interface|g" \
            -e "s|@PEER_IP@|$peer_ip|g" \
            -e "s|@FAIL_THRESHOLD@|$fail_threshold|g" \
            -e "s|@RECOVER_THRESHOLD@|$recover_threshold|g" \
            -e "s|@CHECK_INTERVAL@|$check_interval|g" \
            /etc/keepalived/failover_watchdog.sh
    else
        sed \
            -e "s|@INTERFACE@|$interface|g" \
            -e "s|@PRIORITY@|$priority|g" \
            -e "s|@VIP@|$vip|g" \
            /etc/keepalived/template/keepalived_peer.conf > /tmp/keepalived.conf

        # 替换旁路由脚本变量
        sed -i \
            -e "s|@VIP@|$vip|g" \
            -e "s|@INTERFACE@|$interface|g" \
            /etc/keepalived/vip_up.sh

        sed -i \
            -e "s|@VIP@|$vip|g" \
            -e "s|@INTERFACE@|$interface|g" \
            /etc/keepalived/vip_down.sh
    fi
}

start_service() {
    read_config

    # 设置系统参数
    echo "net.ipv4.ip_nonlocal_bind=1" >> /etc/sysctl.conf
    sysctl -p >/dev/null 2>&1

    # 配置防火墙
    nft add table inet filter 2>/dev/null
    nft add chain inet filter input '{ type filter hook input priority 0; policy accept; }' 2>/dev/null
    nft add rule inet filter input ip protocol 112 accept 2>/dev/null  # VRRP

    # 生成配置文件
    generate_config

    # 启动服务
    if [ "$role" = "main" ]; then
        procd_open_instance
        procd_set_param command "$PROG" -n -f /tmp/keepalived.conf
        procd_set_param respawn
        procd_close_instance

        # 启动监控脚本
        procd_open_instance "watchdog"
        procd_set_param command /etc/keepalived/failover_watchdog.sh
        procd_set_param respawn
        procd_close_instance
    else
        procd_open_instance
        procd_set_param command "$PROG" -n -f /tmp/keepalived.conf
        procd_set_param respawn
        procd_close_instance
    fi

    echo "Keepalived HA started in $role mode"
}

stop_service() {
    read_config

    # 停止服务
    procd_kill_all
    pkill -f failover_watchdog.sh 2>/dev/null

    # 清理VIP
    ip addr del $vip/32 dev $interface 2>/dev/null
    echo "Keepalived HA stopped"
}

restart() {
    stop
    start
}

boot() {
    start
}
    
<%+header%>
<style>
    .log-container {
        background-color: #2c2c2c;
        color: #dcdcdc;
        border-radius: 4px;
        padding: 1em;
        margin: 1em 0;
        max-height: 600px;
        overflow-y: auto;
        font-size: 0.9rem;
        font-family: monospace;
        /* white-space: pre-wrap; */
        line-height: 1.5;
    }
    .log-controls {
        margin-bottom: 1em;
        display: flex;
        gap: 0.5em;
        flex-wrap: wrap;
    }
    .btn {
        padding: 0.5em 1em;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        transition: background-color 0.2s;
    }
    .btn-refresh {
        background-color: #4CAF50;
        color: white;
    }
    .btn-refresh:hover {
        background-color: #45a049;
    }
</style>

<h2><%:Keepalived HA 日志%></h2>

<div class="log-controls">
    <button class="btn btn-refresh" onclick="loadLogs()"><%:手动刷新%></button>
    <span style="align-self: center;"><%:自动刷新间隔：10秒%></span>
</div>

<div class="log-container">
    <div id="system_keepalived_log"><%=system_keepalived_log%></div>
</div>

<script>
    // 加载日志（倒序已通过后端命令实现）
    function loadLogs() {
        const logType = 'system_keepalived';
        const xhr = new XMLHttpRequest();
        xhr.open('GET', '<%=url("admin/services/keepalived-ha/get_logs")%>?type=' + logType + '&t=' + new Date().getTime(), true);
        xhr.timeout = 10000; // 10秒超时

        xhr.onload = function() {
            if (xhr.status === 200) {
                let raw = xhr.responseText;
                // 按星期开头拆分日志
                let lines = raw.split(/(?=Mon|Tue|Wed|Thu|Fri|Sat|Sun)/);
                // 添加换行符
                let formatted = lines.map(line => line.trim()).join('<br>');
                document.getElementById(`${logType}_log`).innerHTML = formatted || '未找到相关日志';
            }
        };

        xhr.ontimeout = function() {
            document.getElementById(`${logType}_log`).textContent = '<%:日志加载超时，请重试%>';
        };

        xhr.onerror = function() {
            document.getElementById(`${logType}_log`).textContent = '<%:网络错误，请重试%>';
        };

        xhr.send();
    }

    // 页面加载后立即刷新，并设置定时自动刷新（每10秒）
    window.onload = function() {
        loadLogs();
        setInterval(loadLogs, 10000); // 10秒自动刷新一次
    };
</script>

<%+footer%>